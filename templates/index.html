{% extends "base.html" %}

{% block content %}

<div id="app" style="display:none;">

    <form id="addForm" class="add-form">
        <textarea id="noteText" placeholder="Upi≈°i novu napomenu..." required></textarea>
        <button type="submit">Spremi</button>
    </form>

    <ul class="notes" id="notesList">
        <li class="empty">Uƒçitavanje...</li>
    </ul>

</div>

<div id="notLoggedIn" style="display:none; text-align:center; margin-top:40px;">
    <p>Niste prijavljeni.</p>
    <a href="/login">Idi na login</a>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentUser = null;

const appEl = document.getElementById("app");
const notLoggedInEl = document.getElementById("notLoggedIn");
const notesList = document.getElementById("notesList");
const addForm = document.getElementById("addForm");
const noteText = document.getElementById("noteText");

// INIT
async function initNotesApp() {
    const { data } = await supabaseClient.auth.getUser();

    if (!data.user) {
        appEl.style.display = "none";
        notLoggedInEl.style.display = "block";
        return;
    }

    currentUser = data.user;
    appEl.style.display = "block";
    notLoggedInEl.style.display = "none";

    loadNotes();
}

// LOAD NOTES
async function loadNotes() {
    notesList.innerHTML = "<li class='empty'>Uƒçitavanje...</li>";

    const { data, error } = await supabaseClient
        .from("notes")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("pinned", { ascending: false })
        .order("created_at", { ascending: false });

    if (error) {
        notesList.innerHTML = "<li class='empty'>Gre≈°ka pri uƒçitavanju</li>";
        return;
    }

    if (!data.length) {
        notesList.innerHTML = "<li class='empty'>Nema napomena.</li>";
        return;
    }

    notesList.innerHTML = "";

    data.forEach(note => {
        const li = document.createElement("li");
        if (note.pinned) li.classList.add("pinned");

        li.innerHTML = `
            <p contenteditable="true"
               onblur="editNote('${note.id}', this.innerText)">
               ${note.content}
            </p>

            <small class="timestamp">
                ${new Date(note.created_at).toLocaleString()}
            </small>

            <div class="actions">
                <button onclick="togglePin('${note.id}', ${note.pinned})">
                    ${note.pinned ? "üìå Otkvaƒçi" : "üìç Pin"}
                </button>

                <button onclick="deleteNote('${note.id}')"
                        class="delete">
                    Obri≈°i
                </button>
            </div>
        `;

        notesList.appendChild(li);
    });
}

// ADD NOTE
addForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const text = noteText.value.trim();
    if (!text) return;

    await supabaseClient.from("notes").insert({
        user_id: currentUser.id,
        content: text
    });

    noteText.value = "";
    loadNotes();
});

// DELETE
async function deleteNote(id) {
    if (!confirm("Obrisati napomenu?")) return;

    await supabaseClient
        .from("notes")
        .delete()
        .eq("id", id);

    loadNotes();
}

// PIN / UNPIN
async function togglePin(id, pinned) {
    await supabaseClient
        .from("notes")
        .update({ pinned: !pinned })
        .eq("id", id);

    loadNotes();
}

// EDIT (on blur)
async function editNote(id, newText) {
    newText = newText.trim();
    if (!newText) return;

    await supabaseClient
        .from("notes")
        .update({ content: newText })
        .eq("id", id);
}

initNotesApp();
</script>
{% endblock %}
