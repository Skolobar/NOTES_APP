{% extends "base.html" %}

{% block content %}

<div id="app" style="display:none;">

    <form id="addForm" class="add-form">
        <textarea id="noteText" placeholder="Upiši novu napomenu..." required></textarea>
        <button type="submit">Spremi</button>
    </form>

    <ul class="notes" id="notesList">
        <li class="empty">Učitavanje...</li>
    </ul>

</div>

<div id="notLoggedIn" style="display:none; text-align:center; margin-top:40px;">
    <p>Niste prijavljeni.</p>
    <a href="/login">Idi na login</a>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentUser = null;

const appEl = document.getElementById("app");
const notLoggedInEl = document.getElementById("notLoggedIn");
const notesList = document.getElementById("notesList");
const addForm = document.getElementById("addForm");
const noteText = document.getElementById("noteText");

// INIT
async function initNotesApp() {
    const { data } = await supabaseClient.auth.getUser();

    if (!data.user) {
        appEl.style.display = "none";
        notLoggedInEl.style.display = "block";
        return;
    }

    currentUser = data.user;
    appEl.style.display = "block";
    notLoggedInEl.style.display = "none";

    loadNotes();
}

// LOAD NOTES
async function loadNotes() {
    notesList.innerHTML = "<li class='empty'>Učitavanje...</li>";

    const { data, error } = await supabaseClient
        .from("notes")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

    if (error) {
        notesList.innerHTML = "<li class='empty'>Greška pri učitavanju</li>";
        return;
    }

    if (!data.length) {
        notesList.innerHTML = "<li class='empty'>Nema napomena.</li>";
        return;
    }

    notesList.innerHTML = "";

    data.forEach(note => {
        const li = document.createElement("li");
        li.innerHTML = `
            <p>${note.content}</p>
            <small class="timestamp">
                ${new Date(note.created_at).toLocaleString()}
            </small>
        `;
        notesList.appendChild(li);
    });
}

// ADD NOTE
addForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const text = noteText.value.trim();
    if (!text) return;

    await supabaseClient
        .from("notes")
        .insert({
            user_id: currentUser.id,
            content: text
        });

    noteText.value = "";
    loadNotes();
});

initNotesApp();
</script>
{% endblock %}
